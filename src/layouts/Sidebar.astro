---
import Nav from '../components/Nav.astro'
import NavItem from '../components/NavItem.astro'
import NavLink from '../components/NavLink.astro'

const { class: className } = Astro.props
---

<aside
  data-nav
  class:list={[
    'fixed left-0 inset-y-0 -translate-x-full [&[open]]:translate-x-0 lg:translate-x-0 w-full lg:w-72 bg-neutral-100/60 backdrop-blur-md pt-16 z-10 transition-transform duration-300 ease-in-out',
    className,
  ]}
>
  <div
    class="w-full h-full lg:border-r border-neutral-300/50 px-5 py-4 overflow-y-auto"
  >
    <Nav>
      <NavItem title="网站导航" open>
        <NavLink href="/" label="返回首页" />
      </NavItem>
      <NavItem title="服务器指南" open>
        <NavLink href="/guide/server_guide" label="指南首页" />
        <NavLink href="/guide/server_guide#server-info" label="服务器信息" />
        <NavLink href="/guide/server_guide#notes" label="服务器注意事项" />
        <NavLink href="/guide/server_guide#login-method" label="登录方式" class="pl-4" />
        <NavLink href="/guide/server_guide#faq" label="常见问题" class="pl-4" />
        <NavLink href="/guide/server_guide#rules" label="服务器规范" class="pl-4" />
      </NavItem>
    </Nav>
  </div>
</aside>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const sidebar = document.querySelector('aside[data-nav]');
    if (!sidebar) return;

    const sidebarLinks = sidebar.querySelectorAll('a[href^="/guide/server_guide"]');
    const sections = Array.from(sidebarLinks)
      .map(link => {
        const hash = (link as HTMLAnchorElement).hash;
        return hash ? document.querySelector(hash) : null;
      })
      .filter(Boolean);

    if (sections.length === 0) return;

    const updateActiveLink = (targetId) => {
      sidebarLinks.forEach(link => {
        const anchor = link as HTMLAnchorElement;
        const linkHref = anchor.getAttribute('href');
        if (targetId && linkHref.endsWith('#' + targetId)) {
          anchor.classList.add('is-active');
        } else if (!targetId && linkHref === '/guide/server_guide') {
          anchor.classList.add('is-active');
        } else {
          anchor.classList.remove('is-active');
        }
      });
    };

    // --- 1. 处理点击事件 (使用手动滚动计算) ---
    sidebarLinks.forEach(link => {
      link.addEventListener('click', (e) => {
        const anchor = e.currentTarget as HTMLAnchorElement;
        const hash = anchor.hash;

        updateActiveLink(hash.substring(1));

        if (hash) {
          e.preventDefault(); // 必须阻止默认行为

          const targetSection = document.querySelector(hash);
          const header = document.querySelector('header'); // 获取顶栏元素

          if (targetSection && header) {
            const headerHeight = header.offsetHeight;
            const elementPosition = targetSection.getBoundingClientRect().top;
            const offsetPosition = elementPosition + window.scrollY - headerHeight;

            // --- 这是实现“居中”的核心计算 ---
            const elementHeight = targetSection.offsetHeight;
            const viewportHeight = window.innerHeight;
            
            // 计算目标位置，使其中心位于可见区域的中心
            const finalScrollPosition = offsetPosition - (viewportHeight / 2) + (elementHeight / 2) + headerHeight;

            window.scrollTo({
              top: finalScrollPosition,
              behavior: 'smooth'
            });

            history.pushState(null, '', hash);
          }
        }
      });
    });

    // --- 2. 处理滚动事件 (逻辑不变) ---
    const observer = new IntersectionObserver((entries) => {
      let topmostVisibleEntry = null;
      for (const entry of entries) {
        if (entry.isIntersecting) {
          topmostVisibleEntry = entry;
          break;
        }
      }
      if (topmostVisibleEntry) {
        updateActiveLink(topmostVisibleEntry.target.id);
      } else if (sections.length > 0 && window.scrollY < sections[0].getBoundingClientRect().top + window.scrollY - 100) {
        updateActiveLink('');
      }
    }, {
      rootMargin: '0px 0px -85% 0px',
    });

    sections.forEach(section => observer.observe(section));

    // --- 3. 初始加载 (逻辑不变) ---
    const initialHash = window.location.hash.substring(1);
    updateActiveLink(initialHash);
  });
</script>